// —Ç–æ–∫–µ–Ω –±–µ—Ä–µ–º —Å .env —Ñ–∞–π–ª–∞
require('dotenv').config()
const token = process.env.BOT_TOKEN
// –±–µ—Ä–µ–º –∞–ø–∏—à–∫—É
const TelegramApi = require('node-telegram-bot-api')

// —Å–æ–∑–¥–∞–µ–º –±–æ—Ç–∞, –¥–µ–ª–∞—è –µ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ã(—Ç–æ–∫–µ–Ω –∏ –ø—Ä–æ—á–∞—è —Ö—É–π–Ω—è –∫–∞—Ä–æ—á–µ —Å—ã—Ä –∑–∞–ª—É–ø–∞)
const bot = new TelegramApi(token, {polling: true})


// —Ç—É—Ç –∫–æ—Ä–æ—á —Ç–µ–º–∫–∞ —à–æ–± –∫–æ–≥–¥–∞ –Ω–∞–∂–∏–º–∞–ª –∫–Ω–æ–ø–∫—É –≤–æ–∑–ª–µ —á–∞—Ç–∞ –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø —É–¥–æ–±–Ω–æ –∫–æ—Ä–æ—á
bot.setMyCommands([
    {command: '/start', description: '–Ω–∞—á–∞–ª–æ'},
    {command: '/account', description: '–º–æ–π –∞–∫–∫–∞—É–Ω—Ç'},
    {command: '/balance', description: '–±–∞–ª–∏–∫'},
    {command: '/help', description: '—Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥'},
    {command: '/cheese', description: '–ø–æ–∫–∞–∑–∞—Ç—å —Å—ã—Ä—ã (–±–æ–Ω—É—Å—ã)'},
    {command: '/verify', description: '–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–æ—Ç–∞'}
])
console.log('bot running...')


const userCaptcha = {} // –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–∞–ø—á—É, –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—ã—Ä–Ω–æ–≥–æ
const verifiedUsers = {} // –∫—Ç–æ —É–∂–µ –ø—Ä–æ—à—ë–ª –∫–∞–ø—á—É ‚Äî –±–æ–ª—å—à–µ –Ω–µ –¥–æ–µ–±—ã–≤–∞–µ–º—Å—è
const captchaAttempts = {} // *–ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è –∫–∞–ø—á–∏
// const userTimeouts = {} // *—Ç–∞–π–º–∞—É—Ç –¥–ª—è –µ–±–ª–∞–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∞–ª–∏–ª–∏ –∫–∞–ø—á—É (–±—É–¥—É—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
let balance = Math.floor(Math.random() * 5000) // –±–∞–ª–∞–Ω—Å (–±—É–¥—É—â–∞—è –æ–±–Ω–æ–≤–∞)
let cheese = Math.floor(Math.random() * 20) // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—ã—Ä–∞ (–±–æ–Ω—É—Å–æ–≤)
let whitelist = false


const start = () => {
    bot.on('message', async msg => {
        const chatId = msg.chat.id
        const userId = msg.from.id
        const text = msg.text

        // –ª–∞–Ω –æ–ø–∏—à—É –∫–∞–∫ –∫–∞–ø—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ü–†–û–ß–ò–¢–ê–ô, –ü–û–õ–ï–ó–ù–û –ù–ê–•–£–ô
        function captcha() {
            // –∫–∞—Ä–æ—á–µ –±–ª—è –±—É–∫–æ–≤–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Ñ–∞—Å–æ–≤–∞—Ç—å—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–∏–∂–µ
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'
            // –ø—É—Å—Ç–∞—è –≥–∞–ª–µ—Ä–∫–∞, —à–æ–± –≤ –Ω–∏—Ö —á–µ—Ç–æ —Ö—É—è—Ä–∏—Ç—å
            let captchaResult = ''
            // —Ü–∏–∫–ª, –≥–¥–µ —É–∫–∞–∑–∞–Ω–æ —á—Ç–æ –¥–ª–∏–Ω–∞ –∫–∞–ø—á–∏ –º–∞–∫—Å–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤, –∏ –æ–Ω–∞ –±—É–¥–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –∏–∑ –±—É–∫–≤ –≤—ã—à–µ
            for (let i = 0; i < 6; i++) {
                captchaResult += chars[Math.floor(Math.random() * chars.length)]
            }
            // –ø—É–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ –ø–æ –≤—Å–µ–º—É –∫–æ–¥—É, –ø–æ—Ç–æ–º—É —à–æ –æ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —à–∞—Ä–∏—à –¥–∞
            return captchaResult
        }

        switch (text) {
            //–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ø—á—É(–æ–±–Ω–æ–≤–∞)
            case '/start':
                // *–ï–°–õ–ò –¢–ò–ü –ó–ê–ï–ë–õ–ê–ù–ò–õ –ö–ê–ü–ß–£ –¢–û –û–ù –ö–ê–ö –°–ê–®–£–ö –ü–û–î –•–ê–†–¨–ö–û–í–û–ú –ë–£–î–ï–¢
                if (!verifiedUsers[userId] && captchaAttempts[userId] === 0) {
                    console.log(`—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ—Å–ª–µ —Ö—É–π–Ω–∏ –≤—Å–µ–π: ` + captchaAttempts[userId])
                    bot.sendMessage(chatId, '–ü–û–®–ï–õ –ù–ê–•–£–ô –£–ï–ë–ò–©–ï')
                    return
                }
                // *–æ—Ç—Å—ã–ª–∞–µ–º –∫–∞–ø—á—É –µ—Å–ª–∏ –Ω–∞–≤–∏—á–æ–∫
                if (!verifiedUsers[userId]) {
                    // –í–ê–ñ–ù–û, —Å–µ–Ω–¥–∫–∞–ø—á–∞ —ç—Ç–æ –º—ã –æ–±—ä–≤–ª—è–µ–º —Ç—É —Å–∞–º—É—é –∫–∞–ø—á—É –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã—Ç–∞—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –±—ã–ª–∞
                    const sendCaptcha = captcha()
                    userCaptcha[userId] = sendCaptcha
                    captchaAttempts[userId] = 4
                    bot.sendMessage(chatId, '–®–æ —Ç—ã –ª—ã—Å—ã–πüßÄüòÇ, –ø—Ä–æ–π–¥–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –±–æ—Ç–∞ –µ–ø—Ç–∞ \n\n‚å®Ô∏è –≤–≤–µ–¥–∏ —Ç–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –Ω–∏–∂–µ –∏ –æ—Ç–ø—Ä–∞–≤—å:\n\n' + sendCaptcha)
                    return
                }
                // *–µ—Å–ª–∏ –Ω–∞–≤–∏—á–æ–∫ —Ç–æ –ø–æ—Ö—É–π –Ω–∞ –Ω–µ–≤–æ
                bot.sendMessage(chatId, '‚úÖ –¢—ã —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω, –º–æ–∂–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–ª—å—à–µ.–ò –µ—Å–ª–∏ –Ω–∞–¥–æ –º–µ–Ω—é, –≥–ª—è–Ω—å /help')
                console.log(`–ø—Ä–æ–≤–µ—Ä–µ–Ω –Ω–∞ –∫–∞–ø—á–µ?: ${verifiedUsers[userId] ? '–¥–∞' : '–æ—à–∏–±–∫–∞'}`)
                break

            case '/account':
                // –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–ª—è —Å—ã—Ä–æ–≤
                bot.sendMessage(chatId, 
                    `üè¶ –¢–≤–æ–π –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç , ${msg.from.first_name}üßÄ \n\n` +
                    `üí≥ –±–∞–ª–∞–Ω—Å: ${balance} ‚ÇΩ\n` +
                    `üßÄ –±–æ–Ω—É—Å—ã (—Å—ã—Ä—ã): üßÄ${cheese}\n` +
                    `üìÑ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ: ${whitelist ? 'üîí–¥–∞' : 'üîì –Ω–µ—Ç'}\n` +
                    `ü§ñ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–æ—Ç–∞: ${verifiedUsers[userId] ? '‚úÖ –ø—Ä–æ–π–¥–µ–Ω–æ' : '‚ùå –æ—à–∏–±–∫–∞'}`
                )
                break
            
            case '/balance':
                bot.sendMessage(chatId, 'test')
                break

            case '/help':
                // –æ–±—ã—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
                bot.sendMessage(chatId, 
                    'üìñ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:\n' +
                    '/start ‚Äì –∑–∞–ø—É—Å–∫\n' +
                    '/account ‚Äì –º–æ–π –∞–∫–∫–∞—É–Ω—Ç\n' +
                    '/balance - –≥–æ–ª–¥–∞ –Ω–∞ –±–∞–ª–∏–∫–µ\n' +
                    '/cheese ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏ –±–æ–Ω—É—Å—ã (—Å—ã—Ä—ã)\n' +
                    '/help ‚Äì –ø–æ–º–æ—â—å\n'
                )
                break

            case '/cheese':
                // –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ–Ω—É—Å—ã
                bot.sendMessage(chatId, `üßÄ–£ —Ç–µ–±—è –Ω–∞ —Å—á–µ—Ç—É: ${cheese} üßÄ –±–æ–Ω—É—Å–Ω—ã—Ö —Å—ã—Ä–æ–≤!`)

            // *–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ø—á—É, –ø–µ—Ä–µ–Ω–µ—Å —Å –æ–±–Ω–æ–≤–æ–π
            default:
                if (!verifiedUsers[userId] && userCaptcha[userId]) {
                    // *–ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–Ω–æ —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞–ø—á—É —á–∏ –Ω–µ
                    if (text === userCaptcha[userId]) {
                        verifiedUsers[userId] = true
                        bot.sendMessage(chatId, '‚úÖ–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —Å—ã—Ä –µ–±–∞–Ω–Ω—ã–π, —Ç–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–æ–π—Ç–∏ –¥–∞–ª—å—à–µ –ø–æ —Ç–æ–π –∂–µ –∫–æ–º–∞–Ω–¥–µ /start')
                        delete captchaAttempts[userId]
                    } else {
                        // *–ø–∞–ø—ã—Ç–∫–∏ –Ω–∞ –∫–∞–ø—á–µ, –∫–æ—Ä–æ—á–µ –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∞ –µ–±—É—á–∏–π –∏—Ñ –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≥–ª—è–¥–∏—Ç —É–±–æ–≥–æ –Ω–∞—Ö—É–π
                        if (captchaAttempts[userId] > 0) {
                            captchaAttempts[userId]--
                            await bot.sendMessage(chatId, `‚ùå –í–≤–µ–¥–µ–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ‚ùó ${captchaAttempts[userId]} ‚ùó`)
                            // *–µ—Å–ª–∏ –ü–†–û–ï–ë–ê–õ–°–Ø, —Ç–æ –ª–æ—Ö –µ–±–∞–Ω–Ω—ã–π
                            if (captchaAttempts[userId] === 0) {
                                await bot.sendMessage(chatId, '‚õî –ö–∞–ø—á–∞ –Ω–µ –±—ã–ª–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ –µ–±–ª–∞–Ω, –ø–æ—Å–æ—Å–∏')
                                return
                            }
                        }
                    }
                }
        }
    })
}

// –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
start()
// —à–æ–± –Ω–∞—Ö–æ–¥–∏–ª–æ —Å—ã—Ä–Ω—ã–µ –æ—à—ã–±–∫–∏
bot.on('polling_error', console.error)
