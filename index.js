// —Ç–æ–∫–µ–Ω –±–µ—Ä–µ–º —Å .env —Ñ–∞–π–ª–∞
require('dotenv').config()
const token = process.env.BOT_TOKEN
// –±–µ—Ä–µ–º –∞–ø–∏—à–∫—É
const TelegramApi = require('node-telegram-bot-api')

// —Å–æ–∑–¥–∞–µ–º –±–æ—Ç–∞, –¥–µ–ª–∞—è –µ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ã(—Ç–æ–∫–µ–Ω –∏ –ø—Ä–æ—á–∞—è —Ö—É–π–Ω—è –∫–∞—Ä–æ—á–µ —Å—ã—Ä –∑–∞–ª—É–ø–∞)
const bot = new TelegramApi(token, {polling: true})


// —Ç—É—Ç –∫–æ—Ä–æ—á —Ç–µ–º–∫–∞ —à–æ–± –∫–æ–≥–¥–∞ –Ω–∞–∂–∏–º–∞–ª –∫–Ω–æ–ø–∫—É –≤–æ–∑–ª–µ —á–∞—Ç–∞ –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø —É–¥–æ–±–Ω–æ –∫–æ—Ä–æ—á
bot.setMyCommands([
    {command: '/start', description: '–Ω–∞—á–∞–ª–æ'},
    {command: '/account', description: '–º–æ–π –∞–∫–∫–∞—É–Ω—Ç'},
    {command: '/balance', description: '–±–∞–ª–∏–∫'},
    {command: '/help', description: '—Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥'},
    {command: '/cheese', description: '–ø–æ–∫–∞–∑–∞—Ç—å —Å—ã—Ä—ã (–±–æ–Ω—É—Å—ã)'},
])
console.log('bot running...')


const userData = {} // *–¥–µ–∫–ª–∞—Ä–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã —é–∑–µ—Ä–∞(–≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
let cheese = Math.floor(Math.random() * 20) // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—ã—Ä–∞ (–±–æ–Ω—É—Å–æ–≤)


const start = () => {
    bot.on('message', async msg => {
        const chatId = msg.chat.id
        const userId = msg.from.id
        const text = msg.text
        // *—à–∞–±–ª–æ–Ω–Ω–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∞–Ω–∫–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —é–∑–µ—Ä–∞(–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–Ω—Å–æ–ª—å –ª–æ–≥–æ–º –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Å—ã—Ä–Ω–æ–π)
        if (!userData[userId]) {
            userData[userId] = {
                // —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–∞–ø—á–∞ –¥–ª—è —é–∑–µ—Ä–∞
                userCaptcha: undefined,
                // —Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –æ—Å—Ç–∞–ª–æ—Å—å —É —é–∑–µ—Ä–∞(–ø—Ä–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É–∂–µ —É–¥–∞–ª—è–µ—Ç—Å—è)
                captchaAttempts: 4,
                // –≥–æ–ª–¥–∞ –Ω–µ –Ω–∞ –±–∞–ª–∏–∫–µ
                balance: 0,
                // —á—É—à–ø–∞–Ω –∏–ª–∏ –Ω–µ—Ç
                whitelist: false,
            // –ø—Ä–æ–≤–µ—Ä–µ–Ω –ª–∏ —Ö—É–π —ç—Ç–æ—Ç
                verifiedUsers: false
            }
        }
        // –ü–†–û–í–ï–†–ö–ê –î–ê–ù–ù–´–• –Æ–ó–ï–†–ê !!!!!!!!!!!!!!!!!!!!!!!!!!! —Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ –Ω–∞—Ö—É–π –æ–Ω–æ –∂–∏–∑–Ω—å —Å–ø–∞—Å–ª–æ –º–Ω–µ –∏ –∑–æ–ª–æ—á–µ–≤—É
        console.log(userData[userId])

        // –ª–∞–Ω –æ–ø–∏—à—É –∫–∞–∫ –∫–∞–ø—á–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ü–†–û–ß–ò–¢–ê–ô, –ü–û–õ–ï–ó–ù–û –ù–ê–•–£–ô
        function captcha() {
            // –∫–∞—Ä–æ—á–µ –±–ª—è –±—É–∫–æ–≤–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Ñ–∞—Å–æ–≤–∞—Ç—å—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–∏–∂–µ
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'
            // –ø—É—Å—Ç–∞—è –≥–∞–ª–µ—Ä–∫–∞, —à–æ–± –≤ –Ω–∏—Ö —á–µ—Ç–æ —Ö—É—è—Ä–∏—Ç—å
            let captchaResult = ''
            // —Ü–∏–∫–ª, –≥–¥–µ —É–∫–∞–∑–∞–Ω–æ —á—Ç–æ –¥–ª–∏–Ω–∞ –∫–∞–ø—á–∏ –º–∞–∫—Å–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤, –∏ –æ–Ω–∞ –±—É–¥–µ—Ç —Å–æ–±–∏—Ä–∞—Ç—å—Å—è –∏–∑ –±—É–∫–≤ –≤—ã—à–µ
            for (let i = 0; i < 6; i++) {
                captchaResult += chars[Math.floor(Math.random() * chars.length)]
            }
            // –ø—É–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ –ø–æ –≤—Å–µ–º—É –∫–æ–¥—É, –ø–æ—Ç–æ–º—É —à–æ –æ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —à–∞—Ä–∏—à –¥–∞
            return captchaResult
        }

        // –ï–°–õ–ò –¢–ò–ü –ó–ê–ï–ë–õ–ê–ù–ò–õ –ö–ê–ü–ß–£ –¢–û –ö–ê–ö –°–ê–®–£–ö–ê –ü–û–î –ó–û–õ–û–ß–ï–í
        if (userData[userId].captchaAttempts === 0 && !['/start'].includes(text) && text !== userData[userId]?.userCaptcha) {
            bot.sendMessage(chatId, `–≤–∞–º –∑–∞–ø—Ä–µ—â–µ–Ω –¥–æ—Å—Ç—É–ø –∏–∑–∑–∞ —Ñ–µ–π–ª–∞ –∫–∞–ø—á–∏`)
            return
        }
        switch (text) {
            //–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ø—á—É(–æ–±–Ω–æ–≤–∞)
            case '/start':
                // *–æ—Ç—Å—ã–ª–∞–µ–º –∫–∞–ø—á—É –µ—Å–ª–∏ –Ω–∞–≤–∏—á–æ–∫
                if (!userData[userId].verifiedUsers) {
                    // –í–ê–ñ–ù–û, —Å–µ–Ω–¥–∫–∞–ø—á–∞ —ç—Ç–æ –º—ã –æ–±—ä–≤–ª—è–µ–º —Ç—É —Å–∞–º—É—é –∫–∞–ø—á—É –∫–æ—Ç–æ—Ä–∞—è –∑–∞–∫—Ä—ã—Ç–∞—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –±—ã–ª–∞
                    const sendCaptcha = captcha()
                    userData[userId].userCaptcha = sendCaptcha
                    bot.sendMessage(chatId, '–®–æ —Ç—ã –ª—ã—Å—ã–πüßÄüòÇ, –ø—Ä–æ–π–¥–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –±–æ—Ç–∞ –µ–ø—Ç–∞ \n\n‚å®Ô∏è –≤–≤–µ–¥–∏ —Ç–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–Ω–æ –Ω–∏–∂–µ –∏ –æ—Ç–ø—Ä–∞–≤—å:\n\n' + sendCaptcha)
                    return
                }
                // *–µ—Å–ª–∏ –Ω–∞–≤–∏—á–æ–∫ —Ç–æ –ø–æ—Ö—É–π –Ω–∞ –Ω–µ–≤–æ
                bot.sendMessage(chatId, '‚úÖ –¢—ã —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω, –º–æ–∂–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–ª—å—à–µ.–ò –µ—Å–ª–∏ –Ω–∞–¥–æ –º–µ–Ω—é, –≥–ª—è–Ω—å /help')
                console.log(`–ø—Ä–æ–≤–µ—Ä–µ–Ω –Ω–∞ –∫–∞–ø—á–µ?: ${userData[userId].verifiedUsers ? '–¥–∞' : '–æ—à–∏–±–∫–∞'}`)
                break

            case '/account':
                // –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–ª—è —Å—ã—Ä–æ–≤
                bot.sendMessage(chatId, 
                    `üè¶ –¢–≤–æ–π –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç , ${msg.from.first_name}üßÄ \n\n` +
                    `üí≥ –±–∞–ª–∞–Ω—Å: ${userData[userId].balance} ‚ÇΩ\n` +
                    `üßÄ –±–æ–Ω—É—Å—ã (—Å—ã—Ä—ã): üßÄ${cheese}\n` +
                    `üìÑ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ: ${userData[userId].whitelist ? 'üîí–¥–∞' : 'üîì –Ω–µ—Ç'}\n` +
                    `ü§ñ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–æ—Ç–∞: ${userData[userId].verifiedUsers ? '‚úÖ –ø—Ä–æ–π–¥–µ–Ω–æ' : '‚ùå –æ—à–∏–±–∫–∞'}`
                )
                break
            
            case '/balance':
                bot.sendMessage(chatId, 'test')
                break

            case '/help':
                // –æ–±—ã—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
                bot.sendMessage(chatId, 
                    'üìñ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:\n' +
                    '/start ‚Äì –∑–∞–ø—É—Å–∫\n' +
                    '/account ‚Äì –º–æ–π –∞–∫–∫–∞—É–Ω—Ç\n' +
                    '/balance - –≥–æ–ª–¥–∞ –Ω–∞ –±–∞–ª–∏–∫–µ\n' +
                    '/cheese ‚Äì –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏ –±–æ–Ω—É—Å—ã (—Å—ã—Ä—ã)\n' +
                    '/help ‚Äì –ø–æ–º–æ—â—å\n'
                )
                break

            case '/cheese':
                // –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ–Ω—É—Å—ã
                bot.sendMessage(chatId, `üßÄ–£ —Ç–µ–±—è –Ω–∞ —Å—á–µ—Ç—É: ${cheese} üßÄ –±–æ–Ω—É—Å–Ω—ã—Ö —Å—ã—Ä–æ–≤!`)

            // *–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ø—á—É, –ø–µ—Ä–µ–Ω–µ—Å —Å –æ–±–Ω–æ–≤–æ–π
            default:
                if (!userData[userId].verifiedUsers && userData[userId].userCaptcha) {
                    // *–ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–Ω–æ —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞–ø—á—É —á–∏ –Ω–µ
                    if (text === userData[userId].userCaptcha) {
                        userData[userId].verifiedUsers = true
                        bot.sendMessage(chatId, '‚úÖ–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —Å—ã—Ä –µ–±–∞–Ω–Ω—ã–π, —Ç–µ–ø–µ—Ä—å —Ç—ã –º–æ–∂–µ—à—å –ø—Ä–æ–π—Ç–∏ –¥–∞–ª—å—à–µ –ø–æ —Ç–æ–π –∂–µ –∫–æ–º–∞–Ω–¥–µ /start')
                        delete userData[userId].userCaptcha
                        delete userData[userId].captchaAttempts
                    } else {
                        // *–ø–∞–ø—ã—Ç–∫–∏ –Ω–∞ –∫–∞–ø—á–µ, –∫–æ—Ä–æ—á–µ –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∞ –µ–±—É—á–∏–π –∏—Ñ –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≥–ª—è–¥–∏—Ç —É–±–æ–≥–æ –Ω–∞—Ö—É–π
                        if (userData[userId].captchaAttempts > 0) {
                            userData[userId].captchaAttempts--
                            await bot.sendMessage(chatId, `‚ùå –í–≤–µ–¥–µ–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –æ—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ‚ùó ${userData[userId].captchaAttempts} ‚ùó`)
                            // *–µ—Å–ª–∏ –ü–†–û–ï–ë–ê–õ–°–Ø, —Ç–æ –ª–æ—Ö –µ–±–∞–Ω–Ω—ã–π
                            if (userData[userId].captchaAttempts === 0) {
                                await bot.sendMessage(chatId, '‚õî –ö–∞–ø—á–∞ –Ω–µ –±—ã–ª–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ –µ–±–ª–∞–Ω, –ø–æ—Å–æ—Å–∏')
                                return
                            }
                        }
                    }
                }
        }
    })
}
// –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é
start()
// —à–æ–± –Ω–∞—Ö–æ–¥–∏–ª–æ —Å—ã—Ä–Ω—ã–µ –æ—à—ã–±–∫–∏
bot.on('polling_error', console.error)
